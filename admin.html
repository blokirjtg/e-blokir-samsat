<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin E-Blokir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { .no-print { display: none !important; } #suratResmi { display: block !important; } }
        #suratResmi { display: none; font-family: 'Times New Roman', Times, serif; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <nav class="bg-slate-900 p-4 text-white shadow-xl no-print flex justify-between items-center">
        <h1 class="font-black text-blue-400 tracking-tighter">ADMIN SAMSAT SEMARANG</h1>
        <div class="flex gap-4">
            <button onclick="renderTable()" class="text-xs bg-blue-700 px-4 py-1.5 rounded-lg font-bold hover:bg-blue-600 transition">REFRESH DATA</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 no-print">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 mt-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">Total Kendaraan Diblokir</h4>
                <p id="totalCount" class="text-3xl font-black text-blue-900">0</p>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">Input Per User</h4>
                <div id="userStats" class="text-xs space-y-1 font-bold text-slate-600"></div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">Pencarian Cepat</h4>
                <input type="text" id="cari" onkeyup="filterTable()" placeholder="Ketik Nopol / Nama User..." class="w-full p-2 border rounded-lg bg-slate-50 outline-none focus:ring-2 focus:ring-blue-400">
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-100 font-black text-slate-500 uppercase border-b">
                        <tr>
                            <th class="p-4">Tanggal</th>
                            <th class="p-4">Unit Samsat</th>
                            <th class="p-4">Penginput</th>
                            <th class="p-4">No. Polisi</th>
                            <th class="p-4 text-center">Arsip Foto</th>
                            <th class="p-4 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody" class="divide-y font-bold text-slate-700">
                        <tr><td colspan="6" class="p-10 text-center italic text-slate-400">Memuat data dari Google Sheets...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="suratResmi" class="p-20 text-black">
        <div class="text-center border-b-4 border-double border-black pb-4 mb-8">
            <h1 class="text-2xl font-bold uppercase">Pemerintah Provinsi Jawa Tengah</h1>
            <h2 class="text-xl font-bold uppercase" id="kopSamsat">Samsat Kota Semarang</h2>
            <p class="text-sm">Alamat Kantor Sesuai Unit Pelayanan Terkait</p>
        </div>
        <h3 class="text-center font-bold underline mb-10 uppercase">Surat Bukti Pemblokiran Jual</h3>
        <p class="mb-4">Diterangkan bahwa kendaraan bermotor dengan identitas:</p>
        <div class="text-center my-10 py-6 border-2 border-black text-4xl font-black font-mono tracking-widest" id="cetakNopol">H 0000 XX</div>
        <p class="mb-10 text-justify">Telah resmi tercatat dalam sistem **E-BLOKIR** pada tanggal <span id="cetakTgl"></span>. Segala bentuk perpindahan kepemilikan wajib melalui prosedur administrasi ulang sesuai peraturan yang berlaku.</p>
        <div class="flex justify-end mt-20">
            <div class="text-center w-64">
                <p>Semarang, <span id="cetakTglTTD"></span></p>
                <p class="mb-20 font-bold uppercase">Petugas Verifikator</p>
                <p class="font-bold underline" id="cetakUser">NAMA USER</p>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjQGzW-4cdphzTngblDEaeAlYO-fx2f9DP28t1_dtGa5VlUA79d7hiwHysg5uX7kF3/exec'; // GANTI INI!
        let db = [];

        async function renderTable() {
            if(SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbxjQGzW-4cdphzTngblDEaeAlYO-fx2f9DP28t1_dtGa5VlUA79d7hiwHysg5uX7kF3/exec') return;
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                db = data.slice(1); // Ambil data, buang baris judul kolom
                filterTable();
            } catch (e) {
                document.getElementById('tbody').innerHTML = '<tr><td colspan="6" class="p-10 text-center text-red-500 font-bold">Gagal terhubung ke Google Sheets.</td></tr>';
            }
        }

        function filterTable() {
            const query = document.getElementById('cari').value.toLowerCase();
            const list = db.filter(x => x[3].toLowerCase().includes(query) || x[1].toLowerCase().includes(query));
            const body = document.getElementById('tbody');
            body.innerHTML = '';
            
            list.forEach((row, index) => {
                const tglFormatted = new Date(row[0]).toLocaleDateString('id-ID');
                body.innerHTML += `
                    <tr class="hover:bg-blue-50 transition">
                        <td class="p-4 text-slate-400">${tglFormatted}</td>
                        <td class="p-4 text-[10px] uppercase text-slate-500">${row[2]}</td>
                        <td class="p-4 uppercase">${row[1]}</td>
                        <td class="p-4 font-black text-blue-900 tracking-widest">${row[3]}</td>
                        <td class="p-4 text-center">
                            <a href="${row[5]}" target="_blank" class="bg-slate-100 text-blue-600 px-3 py-1 rounded-full text-[10px] border border-blue-200">Lihat File</a>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="cetakSurat(${index})" class="bg-blue-800 text-white px-3 py-1 rounded text-[10px] font-black uppercase hover:bg-black transition">Cetak</button>
                        </td>
                    </tr>`;
            });
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = db.length;
            const counts = {};
            db.forEach(x => { counts[x[1]] = (counts[x[1]] || 0) + 1; });
            document.getElementById('userStats').innerHTML = Object.entries(counts)
                .map(([u, c]) => `<div class="flex justify-between border-b pb-1"><span>${u.toUpperCase()}</span><span>${c} Input</span></div>`)
                .join('');
        }

        function cetakSurat(index) {
            const item = db[index];
            document.getElementById('cetakNopol').innerText = item[3];
            document.getElementById('kopSamsat').innerText = 'UPPD / ' + item[2].toUpperCase();
            document.getElementById('cetakTgl').innerText = new Date(item[0]).toLocaleDateString('id-ID');
            document.getElementById('cetakTglTTD').innerText = new Date(item[0]).toLocaleDateString('id-ID');
            document.getElementById('cetakUser').innerText = item[1].toUpperCase();
            window.print();
        }

        window.onload = renderTable;
    </script>
</body>

</html>
